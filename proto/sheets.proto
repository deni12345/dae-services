syntax = "proto3";

package core.v1;
option go_package = "github.com/deni12345/dae-core/proto/gen/corev1;corev1";

import "common.proto";
import "google/protobuf/timestamp.proto";

enum SheetStatus {
  SHEET_STATUS_UNSPECIFIED = 0;
  SHEET_STATUS_PENDING = 1;
  SHEET_STATUS_OPEN = 2;
  SHEET_STATUS_CLOSED = 3;
}

message Sheet {
  string id = 1;
  string name = 2;
  string description = 3;
  string host_user_id = 4;
  Money delivery_fee = 5;
  int32 discount = 6;
  string active_menu_id = 7;
  SheetStatus status = 8;

  google.protobuf.Timestamp created_at = 20;
  google.protobuf.Timestamp updated_at = 21;
}

message SheetMember {
  string user_id = 1;
  string sheet_id = 2;

  google.protobuf.Timestamp joined_at = 20;
}

message ListSheetsFilter {
  string owner_user_id = 1;
  string name_query = 2; // optional substring match (server-defined)
}

service SheetsService {
  rpc CreateSheet(CreateSheetReq) returns (CreateSheetResp);
  rpc GetSheet(GetSheetReq) returns (GetSheetResp);
  rpc UpdateSheet(UpdateSheetReq) returns (UpdateSheetResp);
  rpc ListSheets(ListSheetsReq) returns (ListSheetsResp);

  // Membership management
  rpc JoinSheet(JoinSheetRequest) returns (JoinSheetResponse);
  rpc RemoveMember(RemoveMemberRequest) returns (RemoveMemberResponse);
  rpc ListMembers(ListMembersRequest) returns (ListMembersResponse);

  // External menu attach/refresh (normalized snapshot in your DB).
  rpc AttachMenuWithPayload(AttachMenuWithPayloadReq)
      returns (AttachMenuWithPayloadResp);
  rpc GetMenu(GetMenuReq) returns (GetMenuResp);
}

message CreateSheetReq {
  string idempotency_key = 1;
  string name = 2;
  string description = 3;
  string host_user_id = 4;
  Money delivery_fee = 5;
  int32 discount = 6;
  repeated string member_ids = 7;
  repeated MenuItem items = 10;
}
message CreateSheetResp { Sheet sheet = 1; }

message GetSheetReq { string id = 1; }
message GetSheetResp { Sheet sheet = 1; }

message UpdateSheetReq {
  string id = 1;
  optional string name = 3;
  optional string description = 4;
  optional string active_menu_id = 5;
  optional SheetStatus status = 8;
}
message UpdateSheetResp { Sheet sheet = 1; }

message ListSheetsReq {
  int32 page_size = 1;
  Cursor cursor = 2;
  ListSheetsFilter filter = 3;
}
message ListSheetsResp {
  repeated Sheet sheets = 1;
  optional Cursor next_cursor = 2;
}

message JoinSheetRequest {
  string idempotency_key = 1;
  string sheet_id = 2;
  string user_id = 3;
}
message JoinSheetResponse { SheetMember member = 1; }

message RemoveMemberRequest {
  string sheet_id = 1;
  string user_id = 2;
}
message RemoveMemberResponse {}

message ListMembersRequest {
  string sheet_id = 1;
  int32 page_size = 2;
  Cursor cursor = 5;
}
message ListMembersResponse {
  repeated SheetMember members = 1;
  optional Cursor next_cursor = 2;
}

message MenuItem {
  string id = 1;
  string title = 2;
  Money price = 3;
  string description = 4;
  bool available = 5;

  // Option group contains options like bubbles, sugar level, etc.
  repeated MenuOptionGroup option_groups = 10;
}

message MenuOptionGroup {
  string id = 1;
  string title = 2;

  // Selection rules
  bool required = 3;     // e.g., size must be chosen
  bool multi_select = 4; // true => can pick many
  int32 min_select = 5;  // 0..n
  int32 max_select = 6;  // 1..n

  repeated MenuOption options = 10;
}

message MenuOption {
  string id = 1;
  string title = 2;
  Money price_delta = 3;  // surcharge/discount for ONE unit
  int32 max_quantity = 4; // 1 if not quantifiable; >1 for “double boba”
  bool available = 5;
}

message AttachMenuWithPayloadReq {
  string idempotency_key = 1;
  string sheet_id = 2;

  // The normalized menu items
  repeated MenuItem items = 3;
}

message AttachMenuWithPayloadResp {
  repeated MenuItem items = 1; // stored menu items
  Sheet sheet = 2;             // sheet with active_menu_id updated
}

message GetMenuReq { string sheet_id = 1; }
message GetMenuResp { repeated MenuItem items = 1; }